# Workflow derived from https://github.com/ropensci/rix/tree/main/.github/workflows
# Builds and tests the Nix environment
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: nix-builder

permissions:
  contents: read

jobs:
  run-x86_64-linux:
    name: nix builder for Ubuntu
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - name: Create nix folder to silence warning
      run: mkdir -p ~/.nix-defexpr/channels

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - uses: cachix/cachix-action@v15
      with:
        name: rstats-on-nix  # Public R packages cache - check this FIRST

    - uses: cachix/cachix-action@v15
      with:
        name: johngavin  # Project-specific cache - check this SECOND
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: true  # Don't push standard R packages to johngavin cachix

    - name: Build Nix Environment (CI dependencies)
      run: |
        nix-build --quiet default.nix
        nix-shell --quiet default.nix --run "R --version"

    - name: Build rArimaOption Package as Nix Derivation
      run: |
        nix-build --quiet package.nix

    - name: Push rArimaOption Derivation to Cachix
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Push the rArimaOption package derivation and all its dependencies
        nix-store -qR --include-outputs result | cachix push johngavin
